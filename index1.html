<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>English Typing Game</title>
    <script src="quizData.js"></script>
    <script src="grammarQuizData.js"></script>
    <style>
        /* 基本スタイル */
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #50e3c2;
            --correct-color: #2ecc71;
            --background-color: #f0f4f8;
            --text-color: #333;
            --light-text-color: #fff;
            --border-radius: 12px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100%;
            max-width: 1024px;
            max-height: 1366px;
            background-color: white;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* 画面共通スタイル */
        .screen {
            padding: 40px;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
        }
        
        #home-screen {
             justify-content: flex-start;
             padding-top: 10vh;
        }
        
        #game-screen, #result-screen {
            justify-content: center;
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }

        h1 {
            font-size: 3.5rem;
            color: var(--primary-color);
            margin-bottom: 5vh;
        }

        h2 {
            font-size: 2rem;
            color: var(--text-color);
            margin-bottom: 30px;
            position: relative;
            width: 100%;
        }
        
        /* ホーム画面のスタイル */
        .selection-wrapper {
            width: 100%;
            max-width: 800px;
            display: grid;
        }

        .selection-wrapper > .selection-container {
            grid-column: 1 / -1;
            grid-row: 1 / -1;
            transition: opacity 0.4s ease-in-out, visibility 0.4s;
        }

        .selection-container.hidden {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }
        
        .selection-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }
        
        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        .grid-cols-3 {
             grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .btn {
            padding: 20px 30px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--light-text-color);
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-decoration: none;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        
        .back-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #bdc3c7;
            font-size: 1.2rem;
            padding: 10px 20px;
            color: #333;
        }
        
        .back-to-menu-btn {
            position: absolute;
            left: 40px;
            top: 40px;
            transform: none;
            background: #bdc3c7;
            color: #333;
            font-size: 1.2rem;
            padding: 10px 20px;
        }
        @media (max-width: 768px) {
            .back-to-menu-btn {
                left: 20px;
                top: 20px;
                font-size: 1rem; 
                padding: 8px 15px; 
            }
        }

        /* ゲーム画面のスタイル */
        #game-screen {
            justify-content: space-between;
        }

        .game-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .game-main {
            width: 100%;
        }

        #question-en {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            letter-spacing: 2px;
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        #question-en span {
            transition: color 0.1s;
        }

        #question-en span.correct {
            color: var(--correct-color);
        }

        #question-ja {
            font-size: 1.5rem;
            color: #666;
            margin-bottom: 40px;
        }

        #input-box {
            width: 80%;
            padding: 15px;
            font-size: 2rem;
            text-align: center;
            border: 3px solid var(--primary-color);
            border-radius: var(--border-radius);
            outline: none;
            transition: border-color 0.2s;
        }

        #input-box.error {
            border-color: #e74c3c;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .game-footer {
            width: 100%;
        }

        .home-btn {
            background: #ccc;
            color: #333;
            padding: 15px 30px;
            font-size: 1.2rem;
        }
        
        /* 結果画面のスタイル */
        #result-screen h1 {
            margin-bottom: 50px;
        }

        .result-details {
            font-size: 2rem;
            line-height: 2;
        }

        #result-screen p {
            font-size: 1.8rem;
            margin: 10px 0;
            color: #555;
        }
        
        #result-screen p strong {
            color: var(--primary-color);
            font-size: 1.2em;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .screen {
                padding: 20px;
            }
            h1 { font-size: 2.5rem; }
            h2 { font-size: 1.5rem; }
            .btn { padding: 15px 20px; font-size: 1.2rem; }
            #question-en { font-size: 2rem; min-height: 80px; }
            #question-ja { font-size: 1.2rem; }
            #input-box { font-size: 1.5rem; padding: 10px; width: 90%; }
            .result-details { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="home-screen" class="screen">
            <h1>English Typing Game</h1>

            <div class="selection-wrapper">
                
                <div id="session-selection" class="selection-container">
                    <h2>挑戦したいセッションを選んでください。</h2>
                    <div id="session-buttons" class="selection-grid grid-cols-2">
                        <button class="btn" onclick="alert('名詞セッションは準備中です。意味順ドリルまたは文法項目別をお選びください。')">名詞</button>
                        <button class="btn" onclick="alert('動詞セッションは準備中です。意味順ドリルまたは文法項目別をお選びください。')">動詞</button>
                        <button class="btn" onclick="selectSession('MeaningOrder')">意味順ドリル</button>
                        <button class="btn" onclick="selectSession('Grammar')">文法項目別</button> 
                    </div>
                </div>

                <div id="category-selection" class="selection-container hidden">
                    <button class="btn back-btn" onclick="showSessionSelection()">セッション選択に戻る</button> 
                    <h2>挑戦したいカテゴリを選んでください。</h2>
                    <div id="category-buttons" class="selection-grid grid-cols-3">
                        </div>
                </div>

                <div id="mode-selection" class="selection-container hidden">
                    <button class="btn back-btn" onclick="showCategorySelection()">カテゴリ選択に戻る</button>
                    <h2>挑戦したい**モード**を選んでください。</h2>
                    <div id="mode-buttons" class="selection-grid grid-cols-2">
                        <button class="btn" onclick="selectMode('Practice')">練習モード (時間無制限)</button>
                        <button class="btn" onclick="selectMode('Challenge')">挑戦モード (時間制限あり)</button>
                    </div>
                </div>

            </div>

        </div>

        <div id="game-screen" class="screen hidden">
            <div class="game-header">
                <span id="timer-display">Time: 60</span>
                <span id="score-display">Score: 0</span>
                <span id="progress-display">1/10</span>
                <a href="index.html" class="back-to-menu-btn">ゲーム選択に戻る</a>
            </div>
            <div class="game-main">
                <p id="question-ja"></p>
                <div id="question-en"></div>
                <input type="text" id="input-box" placeholder="ここに入力してください" autofocus autocomplete="off" autocapitalize="off" spellcheck="false">
            </div>
            <div class="game-footer">
                <button id="next-quiz-btn" class="btn hidden">次の問題へ</button>
            </div>
        </div>

        <div id="result-screen" class="screen hidden">
            <h1>結果</h1>
            <p id="result-score">獲得ポイント: <strong>0</strong></p>
            <p id="result-typed-chars">タイプ文字数: <strong>0</strong></p>
            <p id="result-misses">ミスタイプ数: <strong>0</strong></p>
            <button id="retry-btn" class="btn" style="margin-top: 30px;">もう一度挑戦する</button>
            <a href="index.html" class="btn home-btn" style="margin-top: 20px;">ゲーム選択に戻る</a>
        </div>
    </div>

    <script>
        // DOM要素の取得
        const homeScreen = document.getElementById('home-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');

        const sessionSelection = document.getElementById('session-selection');
        const categorySelection = document.getElementById('category-selection');
        const categoryButtonsContainer = document.getElementById('category-buttons');
        const modeSelection = document.getElementById('mode-selection');

        const timerDisplay = document.getElementById('timer-display');
        const scoreDisplay = document.getElementById('score-display');
        const progressDisplay = document.getElementById('progress-display');
        const questionJa = document.getElementById('question-ja');
        const questionEn = document.getElementById('question-en');
        const inputBox = document.getElementById('input-box');
        const nextQuizBtn = document.getElementById('next-quiz-btn');

        const resultScore = document.getElementById('result-score');
        const resultTypedChars = document.getElementById('result-typed-chars');
        const resultMisses = document.getElementById('result-misses');

        // ゲーム状態変数
        let currentQuizList = [];
        let currentQuizIndex = 0;
        let currentText = '';
        let currentTyped = '';
        let score = 0;
        let totalTypedChars = 0;
        let misses = 0;
        let timeLeft = 60;
        let timerInterval;
        let isPerfect = true;
        let currentMode = 'Practice';
        let currentSession = '';
        
        // データソース (quizData.js と grammarQuizData.js に依存)
        // データが存在しない場合を考慮し、空の配列で初期化
        const allQuizData = (typeof allQuizData !== 'undefined') ? allQuizData : []; // 意味順ドリル
        const grammarQuizData = (typeof grammarQuizData !== 'undefined') ? grammarQuizData : []; // 文法項目別
        
        let currentSessionData = [];

        function showScreen(screenId) {
            const screens = [homeScreen, gameScreen, resultScreen];
            screens.forEach(screen => {
                if (screen.id.startsWith(screenId)) {
                    screen.classList.remove('hidden');
                } else {
                    screen.classList.add('hidden');
                }
            });
            if (screenId === 'home') {
                inputBox.blur(); 
            } else if (screenId === 'game') {
                inputBox.focus(); 
            }
        }
        
        function goHome() {
            sessionSelection.classList.remove('hidden');
            categorySelection.classList.add('hidden');
            modeSelection.classList.add('hidden');
            showScreen('home');
        }
        
        function showSessionSelection() {
            // セッション選択画面に戻る
            sessionSelection.classList.remove('hidden');
            categorySelection.classList.add('hidden');
            modeSelection.classList.add('hidden');
        }

        /**
         * セッション選択 (名詞、動詞、意味順ドリル、文法項目別)
         * @param {string} sessionKey 
         */
        function selectSession(sessionKey) {
            currentSession = sessionKey;
            
            let quizData = [];
            if (sessionKey === 'MeaningOrder') {
                quizData = allQuizData; // quizData.js のデータ
            } else if (sessionKey === 'Grammar') {
                quizData = grammarQuizData; // grammarQuizData.js のデータ
            } else {
                quizData = []; 
            }

            currentSessionData = quizData;

            // カテゴリ選択画面のセットアップ
            const categories = [...new Set(currentSessionData.map(quiz => quiz.category))];
            
            categoryButtonsContainer.innerHTML = '';
            if (categories.length === 0) {
                 categoryButtonsContainer.innerHTML = '<p style="color: red; grid-column: 1 / -1;">問題データがありません。</p>';
            }
            
            categories.forEach(categoryName => {
                const button = document.createElement('button');
                button.className = 'btn';
                // 'パターン X: ' の部分を削除して表示 (意味順ドリルカテゴリの場合)
                let buttonText = categoryName.replace(/パターン \d+: /, '');
                button.textContent = buttonText;
                button.onclick = () => selectCategory(categoryName);
                categoryButtonsContainer.appendChild(button);
            });
            
            sessionSelection.classList.add('hidden');
            categorySelection.classList.remove('hidden');
            
            // セッション選択に戻るボタンのロジックはHTML側のonclickで対応済み
        }

        /**
         * カテゴリ選択
         * @param {string} categoryName 
         */
        function selectCategory(categoryName) {
            currentQuizList = currentSessionData.filter(quiz => quiz.category === categoryName);
            
            // 配列をシャッフル
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            shuffleArray(currentQuizList);

            // モード選択画面へ
            categorySelection.classList.add('hidden');
            modeSelection.classList.remove('hidden');
        }
        
        /**
         * カテゴリ選択画面を表示
         */
        function showCategorySelection() {
            sessionSelection.classList.add('hidden');
            categorySelection.classList.remove('hidden');
            modeSelection.classList.add('hidden');
        }

        /**
         * モード選択 (練習/挑戦)
         * @param {string} mode 
         */
        function selectMode(mode) {
            currentMode = mode;
            startGame();
        }

        // --- ゲーム本体ロジック ---

        function startGame() {
            if (currentQuizList.length === 0) {
                 alert('問題データがありません。セッションまたはカテゴリを選択し直してください。');
                 goHome();
                 return;
            }
            
            score = 0;
            totalTypedChars = 0;
            misses = 0;
            currentQuizIndex = 0;
            timeLeft = 60;
            isPerfect = true;
            
            // UI初期化
            scoreDisplay.textContent = `Score: 0`;
            
            if (currentMode === 'Practice') {
                timerDisplay.textContent = '時間無制限';
                timerDisplay.style.color = 'var(--primary-color)';
            } else {
                timerDisplay.textContent = `Time: ${timeLeft}`;
                timerDisplay.style.color = 'var(--text-color)';
            }

            loadQuiz();
            showScreen('game');
        }

        function loadQuiz() {
            if (currentQuizIndex >= currentQuizList.length) {
                endGame();
                return;
            }

            const quiz = currentQuizList[currentQuizIndex];
            // ピリオドやクエスチョンマークを無視して比較するために、入力対象のテキストを整形
            currentText = quiz.en.trim();
            questionJa.textContent = quiz.ja;
            
            currentTyped = '';
            inputBox.value = '';
            inputBox.disabled = false;
            nextQuizBtn.classList.add('hidden');
            updateDisplay();

            if (currentMode === 'Challenge') {
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 1000);
            }
            
            progressDisplay.textContent = `${currentQuizIndex + 1}/${currentQuizList.length}`;
        }
        
        function updateDisplay() {
            questionEn.innerHTML = '';
            const typedLength = currentTyped.length;
            
            for (let i = 0; i < currentText.length; i++) {
                const charSpan = document.createElement('span');
                charSpan.textContent = currentText[i];
                if (i < typedLength) {
                    charSpan.classList.add('correct');
                } else if (i === typedLength) {
                    // 次に入力すべき文字の下線を引く
                    charSpan.style.borderBottom = '3px solid var(--primary-color)';
                }
                questionEn.appendChild(charSpan);
            }
        }
        
        function updateTimer() {
             timeLeft--;
             timerDisplay.textContent = `Time: ${timeLeft}`;
             if (timeLeft <= 10) {
                 timerDisplay.style.color = '#e74c3c'; // 赤色
             } else {
                 timerDisplay.style.color = 'var(--text-color)';
             }

             if (timeLeft <= 0) {
                 endGame();
             }
         }

        inputBox.addEventListener('input', () => {
            const inputText = inputBox.value;

            if (currentText.startsWith(inputText)) {
                currentTyped = inputText;
                totalTypedChars++;
                updateDisplay();

                if (currentTyped === currentText) {
                    // 問題クリア
                    clearInterval(timerInterval);
                    score += currentText.length * 10;
                    if (isPerfect) score += 500; // パーフェクトボーナス

                    scoreDisplay.textContent = `Score: ${score}`;
                    inputBox.disabled = true;
                    nextQuizBtn.classList.remove('hidden');
                    isPerfect = true;
                    currentQuizIndex++;
                }
            } else {
                // タイプミス
                misses++;
                
                if (currentMode === 'Challenge') {
                   // 挑戦モードではミスタイプで時間を減らす
                   timeLeft = Math.max(0, timeLeft - 3); 
                   timerDisplay.textContent = `Time: ${timeLeft}`;
                }

                isPerfect = false;

                // 正しい部分まで巻き戻す
                let correctPart = '';
                for (let i = 0; i < inputText.length; i++) {
                    if (inputText[i] === currentText[i]) {
                        correctPart += inputText[i];
                    } else {
                        break;
                    }
                }
                inputBox.value = correctPart;
                currentTyped = correctPart; // currentTypedも更新
                updateDisplay(); // 表示を即座に更新
                
                inputBox.classList.add('error');
                setTimeout(() => inputBox.classList.remove('error'), 300);
                if(timeLeft <= 0 && currentMode === 'Challenge') endGame();
            }
        });

        function endGame() {
            clearInterval(timerInterval);
            showScreen('result');
            resultScore.querySelector('strong').textContent = score;
            resultTypedChars.querySelector('strong').textContent = totalTypedChars;
            resultMisses.querySelector('strong').textContent = misses;
        }
        
        document.getElementById('retry-btn').addEventListener('click', startGame);
        nextQuizBtn.addEventListener('click', loadQuiz);

        // 初期画面表示
        goHome();
    </script>
</body>
</html>