<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>英語 文整序問題ドリル</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script src="quizData.js"></script> 

    <style>
        /* 基本設定 - 前回の設定を維持 */
        :root {
            --primary-color: #007bff; /* Blue */
            --secondary-color: #6c757d; /* Gray */
            --correct-color: #28a745; /* Green */
            --incorrect-color: #dc3545; /* Red */
            --background-color: #f8f9fa; /* Lighter Background */
            --text-color: #212529;
            --light-text-color: #fff;
            --border-radius: 6px; /* Smaller radius for flatter design */
            --box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); /* Lighter shadow */
            --container-padding: 25px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Meiryo", sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
        }

        .container {
            width: 90%;
            max-width: 800px;
            background-color: #fff;
            padding: var(--container-padding);
            padding-top: calc(var(--container-padding) + 40px);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); 
            text-align: center;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 2.5rem;
        }

        h2 {
            color: var(--text-color);
            margin-bottom: 15px;
            font-size: 1.8rem;
        }
        
        .hidden {
            display: none !important;
        }

        /* 共通ボタン */
        .btn {
            padding: 12px 25px; 
            font-size: 1.1rem; 
            font-weight: 500;
            color: var(--light-text-color);
            background: var(--primary-color); 
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: var(--box-shadow);
            margin: 8px;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-1px);
            background-color: #0056b3; 
            border-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* トップメニューに戻るボタンのスタイル */
        .top-left-button {
            position: absolute;
            top: 15px;
            left: 15px;
            background-color: var(--secondary-color);
            color: white;
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 4px; 
            border: none;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .top-left-button:hover {
            background-color: #5a6268;
            transform: none;
        }

        /* --- メニュー画面 --- */
        #menu-container {
            justify-content: flex-start;
            padding-top: calc(var(--container-padding) + 40px);
        }
        
        /* カテゴリ・モードボタン */
        .category-button {
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--light-text-color);
            background: #17a2b8; /* シアン系のソリッドカラー */
            border: 1px solid #17a2b8;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, opacity 0.3s;
            box-shadow: var(--box-shadow);
            margin: 5px; 
        }
        .category-button:hover {
             background-color: #117a8b;
             border-color: #117a8b;
        }
        
        /* カテゴリリストの3列グリッド配置 (前回修正) */
        #category-list {
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px;
            margin-top: 20px;
        }
        
        .back-link {
            background: var(--incorrect-color); 
            border-color: var(--incorrect-color);
            margin-top: 10px;
        }
        .back-link:hover {
            background-color: #c82333;
            border-color: #c82333;
        }

        /* --- クイズ画面 --- */
        .timer-style {
            font-size: 2.5em; 
            font-weight: bold;
            --timer-default-color: var(--primary-color);
            --timer-default-border: var(--primary-color);
            --timer-timeout-color: var(--incorrect-color);
            
            color: var(--timer-default-color);
            margin-bottom: 20px;
            padding: 10px;
            border: 3px solid var(--timer-default-border); 
            border-radius: 10px;
            display: inline-block;
            background-color: #fff;
            transition: color 0.3s, border-color 0.3s;
        }

        .question-text {
            font-size: 1.4rem;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #e9ecef; 
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.5;
            font-weight: 500;
        }
        
        /* 単語タイルコンテナ */
        .word-box {
            min-height: 60px;
            border: 2px dashed #adb5bd; 
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            width: 100%;
            box-sizing: border-box;
            background-color: #fff;
        }

        #answer-area {
            border-color: var(--primary-color);
            justify-content: flex-start;
        }
        
        /* 単語タイル（選択肢）のスタイル変更 */
        .word-item {
            cursor: pointer;
            background-color: #343a40; 
            color: var(--light-text-color);
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.15s, transform 0.1s;
            font-weight: normal; 
            font-size: 1.0rem; 
            border: 1px solid #212529;
            box-shadow: none; 
        }

        .word-item:active {
            cursor: grabbing;
            transform: scale(1.03);
            background-color: #212529;
        }
        /* 解答エリア内の単語のみドラッグカーソルを表示 */
        #answer-area .word-item {
             cursor: grab;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        /* 結果メッセージの色設定 */
        .correct { color: var(--correct-color); font-weight: bold; font-size: 1.3rem; }
        .incorrect { color: var(--incorrect-color); font-weight: bold; font-size: 1.3rem; }

        /* --- 結果テーブルのスタイル --- */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95rem;
        }
        .results-table th, .results-table td {
            border: 1px solid #dee2e6; 
            padding: 10px 5px;
            text-align: center;
        }
        .results-table th {
            background-color: #e9ecef; 
            font-weight: bold;
        }
        .result-correct-text {
            color: var(--correct-color);
            font-weight: bold;
        }
        .result-incorrect-text {
            color: var(--incorrect-color);
            font-weight: bold;
        }
        .results-table tbody tr:nth-child(even) {
            background-color: #f8f9fa; 
        }
        .results-table .result-correct-cell {
            color: var(--correct-color);
            font-weight: bold;
        }
        .results-table .result-incorrect-cell {
            color: var(--incorrect-color);
            font-weight: bold;
        }

        /* レスポンシブ対応 */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
                padding-top: calc(15px + 40px);
            }
            h1 { font-size: 2rem; }
            .question-text { font-size: 1.2rem; }
            .word-item { padding: 6px 10px; font-size: 0.9rem; }
            .btn, .category-button { padding: 10px 20px; font-size: 1rem; }
            
            /* スマホサイズでは2列表示 */
            #category-list {
                grid-template-columns: repeat(2, 1fr); 
            }
        }
    </style>
</head>
<body>

    <button id="back-to-menu-button" class="top-left-button hidden">メニューに戻る</button>
    
    <div id="menu-container" class="container">
        <h1>英語 文整序問題ドリル</h1>
        
        <p style="margin-top: -10px;">「意味順ドリル」</p>

        <p>挑戦したい**モード**を選んでください。</p>
        <div id="mode-selection">
            <button id="mode-practice" class="category-button">練習モード</button>
            <button id="mode-test" class="category-button">テストモード</button>
        </div>
        
        <button id="back-to-mode-selection" class="btn back-link hidden">ゲーム選択に戻る</button>

        <div id="quiz-count-selection" class="hidden">
            <p>次に、挑戦したい**問題数**を選んでください。</p>
            <div id="count-list">
                <button id="count-5" class="category-button">5問</button>
                <button id="count-10" class="category-button">10問</button>
                <button id="count-20" class="category-button">20問</button>
            </div>
        </div>

        <div id="category-selection" class="hidden">
            <p>次に、挑戦したい**カテゴリ**を選んでください。</p>
            <div id="category-list">
                </div>
        </div>
    </div>

    <div id="quiz-container" class="container hidden">
        
        <div id="result-summary-container" class="hidden">
            <h2>テスト結果</h2>
            <p id="test-summary-message" style="font-size: 1.5em; font-weight: bold; margin-bottom: 20px;"></p>
            <table id="results-table" class="results-table">
                </table>
            </div>

        <div id="question-area">
            <div id="timer-display" class="timer-style hidden">00:15</div>
            
            <h2 id="quiz-category-title"></h2>
            <p id="japanese-question" class="question-text"></p>
            
            <p style="font-size: 0.9em; color: #7f8c8d; margin: 0;">【解答欄: ドラッグ＆ドロップで並べ替え】</p>
            <div id="answer-area" class="word-box">
                </div>

            <div id="correct-answer-display" class="hidden"></div>
            
            <p style="font-size: 0.9em; color: #7f8c8d; margin: 0;">【選択肢: タップで解答欄へ】</p>
            <div id="options-area" class="word-box">
                </div>

            <div class="button-container">
                <button id="check-button" class="btn">答え合わせ</button>
                <button id="show-correct-button" class="btn hidden">正解を見る</button>
                <button id="hide-correct-button" class="btn hidden">正解を隠す</button>
                <button id="next-button" class="btn hidden">次の問題へ</button>
            </div>
            
            <p id="result-message"></p>
        </div>
    </div>

    <script>
        // ==================================
        // 全問題データ
        // const allQuizData は quizData.js で定義され、このスクリプト内で利用されます。
        // ==================================

        // ==================================
        // DOM要素の取得 (機能維持)
        // ==================================
        const menuContainer = document.getElementById('menu-container');
        const quizContainer = document.getElementById('quiz-container');
        
        // メニュー画面
        const backToMenuButton = document.getElementById('back-to-menu-button');
        const modePracticeButton = document.getElementById('mode-practice');
        const modeTestButton = document.getElementById('mode-test');
        const backToModeSelectionButton = document.getElementById('back-to-mode-selection');
        const quizCountSelection = document.getElementById('quiz-count-selection');
        const countList = document.getElementById('count-list');
        const categorySelection = document.getElementById('category-selection');
        const categoryList = document.getElementById('category-list');
        
        // クイズ画面
        const timerDisplay = document.getElementById('timer-display');
        const japaneseQuestion = document.getElementById('japanese-question');
        const quizCategoryTitle = document.getElementById('quiz-category-title');
        const answerArea = document.getElementById('answer-area');
        const optionsArea = document.getElementById('options-area');
        const checkButton = document.getElementById('check-button');
        const showCorrectButton = document.getElementById('show-correct-button');
        const hideCorrectButton = document.getElementById('hide-correct-button');
        const nextButton = document.getElementById('next-button');
        const resultMessage = document.getElementById('result-message');
        const correctAnswerDisplay = document.getElementById('correct-answer-display');
        const questionArea = document.getElementById('question-area');
        
        // 結果画面
        const resultSummaryContainer = document.getElementById('result-summary-container');
        const resultsTable = document.getElementById('results-table');
        
        // ==================================
        // ゲーム状態変数 (機能維持)
        // ==================================
        let availableQuizzes = [];
        let currentQuizIndex = 0;
        let currentQuizData = null;
        let currentMode = '';
        let selectedQuizCount = 0;
        let testResults = [];
        let isAnswered = false;
        
        // タイマー変数 (テストモード用)
        let timerInterval = null;
        const TIME_LIMIT_PER_QUIZ = 15;
        let timeLeft = TIME_LIMIT_PER_QUIZ;

        // Sortable.jsのインスタンスを保持
        let sortableAnswer = null;
        
        // ==================================
        // 修正: タップ（クリック）による単語移動ハンドラをグローバルに定義 (機能維持)
        // ==================================
        /**
         * 単語タイルをクリック/タップした際の移動処理
         */
        const handleItemClick = (e) => {
            // isAnsweredがtrueの場合は操作を無視
            if (isAnswered) return;
            
            const item = e.target.closest('.word-item');
            if (!item) return;

            const parent = item.parentNode;

            if (parent === optionsArea) {
                // 選択肢エリアから解答エリアへ (末尾に追加)
                answerArea.appendChild(item);
                item.style.cursor = 'grab'; // 解答欄に追加された単語はドラッグ可能になる
            } else if (parent === answerArea) {
                // 解答エリアから選択肢エリアへ (元の場所に戻す)
                optionsArea.appendChild(item);
                item.style.cursor = 'pointer'; // 選択肢に戻った単語はクリック可能になる
            }
        };

        // ==================================
        // 関数定義 (機能維持)
        // ==================================
        
        /**
         * CSSカスタムプロパティの値を取得するヘルパー関数
         */
        const getCssVar = (propertyName) => {
            return getComputedStyle(document.documentElement).getPropertyValue(propertyName).trim();
        };

        /**
         * 配列をシャッフルする
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * 画面を切り替える
         */
        function showScreen(screenId) {
            if (screenId === 'menu') {
                menuContainer.classList.remove('hidden');
                quizContainer.classList.add('hidden');
                backToMenuButton.classList.add('hidden');
                resetMenuUI();
            } else if (screenId === 'quiz') {
                menuContainer.classList.add('hidden');
                quizContainer.classList.remove('hidden');
                resultSummaryContainer.classList.add('hidden');
                questionArea.classList.remove('hidden');
                backToMenuButton.classList.remove('hidden');
            }
        }
        
        /**
         * メニューUIを初期状態（モード選択）に戻す
         */
        function resetMenuUI() {
            modePracticeButton.style.opacity = '1.0';
            modeTestButton.style.opacity = '1.0';
            quizCountSelection.classList.add('hidden');
            categorySelection.classList.add('hidden');
            backToModeSelectionButton.classList.add('hidden');
        }

        /**
         * カテゴリボタンを生成し、メニュー画面を表示
         */
        function createCategoryButtons() {
            // allQuizDataはquizData.jsから読み込まれていることを前提とする
            if (typeof allQuizData === 'undefined' || allQuizData.length === 0) {
                console.error("問題データ (allQuizData) が読み込まれていません。quizData.jsのファイル名と配置を確認してください。");
                categoryList.innerHTML = '<p style="color: red;">エラー: 問題データが読み込めません。</p>';
                return;
            }
            
            const categories = [...new Set(allQuizData.map(quiz => quiz.category))];
            categoryList.innerHTML = '';
            
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = 'category-button';
                button.addEventListener('click', () => selectCategory(category));
                categoryList.appendChild(button);
            });
            
            showScreen('menu');
        }

        /**
         * モードを選択
         */
        function selectMode(mode) {
            currentMode = mode;
            
            modePracticeButton.style.opacity = mode === 'practice' ? '1.0' : '0.5';
            modeTestButton.style.opacity = mode === 'test' ? '1.0' : '0.5';
            
            // 「ゲーム選択に戻る」ボタンを表示
            backToModeSelectionButton.classList.remove('hidden');

            if (mode === 'test') {
                quizCountSelection.classList.remove('hidden');
                categorySelection.classList.add('hidden');
            } else {
                selectedQuizCount = 0;
                quizCountSelection.classList.add('hidden');
                categorySelection.classList.remove('hidden');
            }
        }

        /**
         * モード選択画面にリセット
         */
        function resetToModeSelection() {
            currentMode = '';
            selectedQuizCount = 0;
            resetMenuUI();
        }
        
        /**
         * 問題数を選択
         */
        function selectQuizCount(count) {
            selectedQuizCount = count;
            Array.from(countList.children).forEach(btn => {
                const btnCount = parseInt(btn.id.replace('count-', ''));
                btn.style.opacity = btnCount === count ? '1.0' : '0.5';
            });
            
            categorySelection.classList.remove('hidden');
        }
        
        /**
         * カテゴリを選択し、ゲームを開始
         */
        function selectCategory(category) {
            availableQuizzes = allQuizData.filter(quiz => quiz.category === category);
            shuffleArray(availableQuizzes);
            
            if (currentMode === 'test' && selectedQuizCount > 0) {
                availableQuizzes = availableQuizzes.slice(0, selectedQuizCount);
            }
            
            currentQuizIndex = 0;
            testResults = [];
            isAnswered = false;

            showScreen('quiz');
            loadQuiz();
        }

        /**
         * 現在の問題を表示
         */
        function loadQuiz() {
            if (currentQuizIndex >= availableQuizzes.length || availableQuizzes.length === 0) {
                showResult();
                return;
            }

            currentQuizData = availableQuizzes[currentQuizIndex];
            isAnswered = false;
            
            // UIリセット
            resultMessage.textContent = '';
            correctAnswerDisplay.classList.add('hidden');
            showCorrectButton.classList.add('hidden');
            hideCorrectButton.classList.add('hidden');
            checkButton.classList.remove('hidden');
            nextButton.classList.add('hidden');
            
            answerArea.style.borderColor = getCssVar('--primary-color'); 
            answerArea.style.borderStyle = 'dashed';

            // タイマーの表示/非表示
            if (currentMode === 'test') {
                timerDisplay.classList.remove('hidden');
                startTimer();
            } else {
                timerDisplay.classList.add('hidden');
                showCorrectButton.classList.remove('hidden');
            }
            
            // 問題情報の表示
            const questionNumber = currentQuizIndex + 1;
            const totalQuestions = availableQuizzes.length;
            
            quizCategoryTitle.textContent = `${questionNumber}/${totalQuestions} - ${currentQuizData.category}`;
            japaneseQuestion.textContent = currentQuizData.ja;

            // 修正: 英文のピリオドを分離して単語に分割
            const tempSentence = currentQuizData.en.replace(/([.])/g, ' $1 ').trim();
            const rawWords = tempSentence.split(/\s+/).filter(word => word.length > 0);
            
            const shuffledWords = shuffleArray([...rawWords]);
            
            answerArea.innerHTML = '';
            optionsArea.innerHTML = '';

            // 単語タイル生成
            shuffledWords.forEach(word => {
                const item = document.createElement('div');
                item.className = 'word-item';
                item.textContent = word;
                optionsArea.appendChild(item);
            });
            
            // Sortable.jsを初期化
            initializeSortable();
            
            // タップ操作のカーソルをリセット
            Array.from(optionsArea.children).forEach(item => {
                 item.style.cursor = 'pointer';
            });
        }

        /**
         * Sortable.jsの初期化
         */
        function initializeSortable() {
            // 既存のSortableインスタンスを破棄
            if (sortableAnswer) sortableAnswer.destroy();
            
            // 解答エリア (Answer Area) - 内部での並べ替えのみ許可
            sortableAnswer = new Sortable(answerArea, {
                animation: 150,
                group: { name: 'answer-group', pull: false, put: false },
            });
        }
        
        /**
         * タイマーを開始 (テストモード用)
         */
        function startTimer() {
            stopTimer();
            timeLeft = TIME_LIMIT_PER_QUIZ;
            timerDisplay.textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
            
            const primaryColor = getCssVar('--primary-color');
            const incorrectColor = getCssVar('--incorrect-color');

            timerDisplay.style.borderColor = primaryColor;
            timerDisplay.style.color = primaryColor;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 5 && timeLeft > 0) {
                    timerDisplay.style.borderColor = incorrectColor;
                    timerDisplay.style.color = incorrectColor;
                } else if (timeLeft > 5) {
                    timerDisplay.style.borderColor = primaryColor;
                    timerDisplay.style.color = primaryColor;
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = 'TIME UP';
                    checkAnswer(true);
                }
            }, 1000);
        }

        /**
         * タイマーを停止
         */
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        /**
         * ユーザーの解答をチェック
         */
        function checkAnswer(isTimeout = false) {
            if (isAnswered) return;
            isAnswered = true;
            stopTimer();
            
            const correctColor = getCssVar('--correct-color');
            const incorrectColor = getCssVar('--incorrect-color');

            const userAnswerWords = Array.from(answerArea.children).map(item => item.textContent.trim());
            const userAnswer = userAnswerWords.join(' ').trim();
            const correctAnswer = currentQuizData.en.trim();

            // 比較用に句読点と大文字小文字を無視して正規化
            const normalize = (text) => text.toLowerCase().replace(/[.,;?!]/g, '').trim();
            const isCorrect = normalize(userAnswer) === normalize(correctAnswer);

            // UIの更新
            checkButton.classList.add('hidden');
            nextButton.classList.remove('hidden');
            showCorrectButton.classList.add('hidden');
            hideCorrectButton.classList.add('hidden');
            
            // ドラッグ操作を無効化
            if (sortableAnswer) sortableAnswer.option('disabled', true);

            // フィードバック表示
            if (isTimeout) {
                resultMessage.className = 'incorrect';
                resultMessage.textContent = '❌ 時間切れです！不正解。';
                answerArea.style.borderColor = incorrectColor;
                answerArea.style.borderStyle = 'solid';
            } else {
                if (isCorrect) {
                    resultMessage.className = 'correct';
                    resultMessage.textContent = '⭕ 正解です！';
                    answerArea.style.borderColor = correctColor;
                    answerArea.style.borderStyle = 'solid';
                } else {
                    resultMessage.className = 'incorrect';
                    resultMessage.textContent = '❌ 残念！不正解です。';
                    answerArea.style.borderColor = incorrectColor;
                    answerArea.style.borderStyle = 'solid';
                }
            }
            
            // テストモードでは結果を保存
            if (currentMode === 'test') {
                testResults.push({
                    question: currentQuizData.ja,
                    correctAnswer: correctAnswer,
                    userAnswer: userAnswer,
                    isCorrect: isCorrect,
                    time: isTimeout ? 'TIMEOUT' : (TIME_LIMIT_PER_QUIZ - timeLeft)
                });
                
                if (currentQuizIndex === availableQuizzes.length - 1) {
                    nextButton.textContent = '結果を見る';
                } else {
                    nextButton.textContent = '次の問題へ';
                }
            } else if (currentMode === 'practice') {
                 showCorrectAnswer();
            }
        }

        /**
         * 次の問題へ進む
         */
        function nextQuiz() {
            if (currentMode === 'test' && currentQuizIndex === availableQuizzes.length - 1) {
                showResult();
                return;
            }
            
            currentQuizIndex++;
            loadQuiz();
        }

        /**
         * 練習モードで正解を表示
         */
        function showCorrectAnswer() {
            correctAnswerDisplay.textContent = `正解: ${currentQuizData.en}`;
            correctAnswerDisplay.classList.remove('hidden');
            showCorrectButton.classList.add('hidden');
            
            if(currentMode === 'practice') {
                hideCorrectButton.classList.remove('hidden');
            }
        }
        
        /**
         * 練習モードで正解を隠す
         */
        function hideCorrectAnswer() {
            correctAnswerDisplay.classList.add('hidden');
            hideCorrectButton.classList.add('hidden');
            showCorrectButton.classList.remove('hidden');
        }

        /**
         * 結果画面を表示
         */
        function showResult() {
            // 結果画面でもメニューに戻るボタンを表示
            backToMenuButton.classList.remove('hidden');

            questionArea.classList.add('hidden');
            resultSummaryContainer.classList.remove('hidden');

            const total = testResults.length;
            const correct = testResults.filter(res => res.isCorrect).length;
            const accuracy = total > 0 ? ((correct / total) * 100).toFixed(1) : 0;
            
            const summaryMessage = `正解数: ${correct} / ${total} 問 (正答率: ${accuracy}%)`;
            document.getElementById('test-summary-message').textContent = summaryMessage;

            // 結果テーブルの生成
            let tableHTML = `
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>日本語訳</th>
                        <th>正解</th>
                        <th>あなたの解答</th>
                        <th>結果</th>
                        <th>所要時間 (秒)</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            testResults.forEach((res, index) => {
                const resultText = res.isCorrect ? '正解' : '不正解';
                const resultClass = res.isCorrect ? 'result-correct-cell' : 'result-incorrect-cell';
                const timeTaken = res.time === 'TIMEOUT' ? 'タイムアウト' : res.time + '秒';
                
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: left;">${res.question}</td>
                        <td class="result-correct-text" style="text-align: left;">${res.correctAnswer}</td>
                        <td style="text-align: left;">${res.userAnswer}</td>
                        <td class="${resultClass}">${resultText}</td>
                        <td>${timeTaken}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody>';
            resultsTable.innerHTML = tableHTML;
        }

        /**
         * メニューに戻る処理 (全リセット)
         */
        function backToMenu() {
            stopTimer();
            currentMode = '';
            selectedQuizCount = 0;
            testResults = [];
            createCategoryButtons();
        }


        // ==================================
        // イベントリスナー (機能維持)
        // ==================================
        modePracticeButton.addEventListener('click', () => selectMode('practice'));
        modeTestButton.addEventListener('click', () => selectMode('test'));
        backToModeSelectionButton.addEventListener('click', resetToModeSelection);
        
        Array.from(countList.children).forEach(btn => {
            btn.addEventListener('click', () => {
                const count = parseInt(btn.id.replace('count-', ''));
                selectQuizCount(count);
            });
        });

        checkButton.addEventListener('click', () => checkAnswer(false));
        showCorrectButton.addEventListener('click', showCorrectAnswer); 
        hideCorrectButton.addEventListener('click', hideCorrectAnswer); 
        nextButton.addEventListener('click', nextQuiz);
        
        // トップメニューに戻るボタンのロジック
        backToMenuButton.addEventListener('click', backToMenu);

        // タップ（クリック）移動のリスナーを一度だけ登録
        optionsArea.addEventListener('click', handleItemClick);
        answerArea.addEventListener('click', handleItemClick);

        // アプリケーションの初期起動
        window.onload = createCategoryButtons;
    </script>
</body>
</html>