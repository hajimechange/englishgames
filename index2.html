<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>並べ替えドリル</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="quizData.js"></script> 
    <script src="grammarQuizData.js"></script> 

    <style>
        /* 基本設定 */
        :root {
            --primary-color: #007bff; /* Blue */
            --secondary-color: #6c757d; /* Gray */
            --correct-color: #28a745; /* Green */
            --incorrect-color: #dc3545; /* Red */
            --background-color: #f8f9fa; /* Lighter Background */
            --text-color: #212529;
            --light-text-color: #fff;
            --border-radius: 6px; 
            --box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); 
            --container-padding: 25px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Meiryo", sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
        }

        .container {
            width: 90%;
            max-width: 800px;
            background-color: #fff;
            padding: var(--container-padding);
            padding-top: calc(var(--container-padding) + 40px);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); 
            text-align: center;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 2.5rem;
        }

        h2 {
            color: var(--text-color);
            margin-bottom: 15px;
            font-size: 1.8rem;
        }
        
        .hidden {
            display: none !important;
        }

        /* 共通ボタン */
        .btn {
            padding: 12px 25px; 
            font-size: 1.1rem; 
            font-weight: 500;
            color: var(--light-text-color);
            background: var(--primary-color); 
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: var(--box-shadow);
            margin: 8px;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-1px);
            background-color: #0056b3; 
            border-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* 修正: トップメニューに戻るボタン（常に表示されるように hidden を削除）*/
        .top-left-button {
            position: absolute;
            top: 15px;
            left: 15px;
            background-color: var(--secondary-color); /* 灰色 */
            color: white;
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 4px; 
            border: none;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-decoration: none; 
            display: inline-block; 
        }
        .top-left-button:hover {
            background-color: #5a6268;
            transform: none;
        }

        /* --- メニュー画面 --- */
        #menu-container {
            justify-content: flex-start;
            padding-top: calc(var(--container-padding) + 40px);
        }
        
        /* カテゴリ・モードボタン */
        .category-button {
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--light-text-color);
            background: #17a2b8; /* シアン系のソリッドカラー */
            border: 1px solid #17a2b8;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, opacity 0.3s;
            box-shadow: var(--box-shadow);
            margin: 5px; 
        }
        .category-button:hover {
             background-color: #117a8b;
             border-color: #117a8b;
        }
        
        /* カテゴリリストの3列グリッド配置 */
        #category-list {
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px;
            margin-top: 20px;
        }
        
        .back-link {
            background: var(--incorrect-color); 
            border-color: var(--incorrect-color);
            margin-top: 10px;
        }
        .back-link:hover {
            background-color: #c82333;
            border-color: #c82333;
        }

        /* --- クイズ画面 --- */
        .timer-style {
            font-size: 2.5em; 
            font-weight: bold;
            --timer-default-color: var(--primary-color);
            --timer-default-border: var(--primary-color);
            --timer-timeout-color: var(--incorrect-color);
            
            color: var(--timer-default-color);
            margin-bottom: 20px;
            padding: 10px;
            border: 3px solid var(--timer-default-border); 
            border-radius: 10px;
            display: inline-block;
            background-color: #fff;
            transition: color 0.3s, border-color 0.3s;
        }
        
        /* 修正: ゲーム画面のタイトル（カテゴリ名）のフォントサイズを縮小 */
        #quiz-category-title {
            font-size: 1.3rem; 
            margin-bottom: 15px;
            font-weight: normal;
        }
        
        /* 修正: 何問中何問の数字を赤色に */
        .quiz-status-number {
            color: var(--incorrect-color); /* 赤色 */
            font-weight: bold;
        }

        /* 修正: 日本語訳のフォントサイズを拡大 */
        .question-text {
            font-size: 1.6rem; 
            margin-bottom: 30px;
            padding: 15px;
            background-color: #e9ecef; 
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.5;
            font-weight: 500;
        }
        
        /* 単語タイルコンテナ */
        .word-box {
            min-height: 60px;
            border: 2px dashed #adb5bd; 
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            width: 100%;
            box-sizing: border-box;
            background-color: #fff;
        }

        #answer-area {
            border-color: var(--primary-color);
            justify-content: flex-start;
        }
        
        /* 修正: 単語タイル（選択肢）のフォントサイズを拡大 */
        .word-item {
            cursor: pointer;
            background-color: #343a40; 
            color: var(--light-text-color);
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.15s, transform 0.1s;
            font-weight: normal; 
            font-size: 1.1rem; 
            border: 1px solid #212529;
            box-shadow: none; 
        }

        .word-item:active {
            cursor: grabbing;
            transform: scale(1.03);
            background-color: #212529;
        }
        /* 解答エリア内の単語のみドラッグカーソルを表示 */
        #answer-area .word-item {
             cursor: grab;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        /* 結果メッセージの色設定 */
        .correct { color: var(--correct-color); font-weight: bold; font-size: 1.3rem; }
        .incorrect { color: var(--incorrect-color); font-weight: bold; font-size: 1.3rem; }

        /* --- 結果テーブルのスタイル --- */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95rem;
        }
        .results-table th, .results-table td {
            border: 1px solid #dee2e6; 
            padding: 10px 5px;
            text-align: center;
        }
        .results-table th {
            background-color: #e9ecef; 
            font-weight: bold;
        }
        .result-correct-text {
            color: var(--correct-color);
            font-weight: bold;
        }
        .result-incorrect-text {
            color: var(--incorrect-color);
            font-weight: bold;
        }
        .results-table tbody tr:nth-child(even) {
            background-color: #f8f9fa; 
        }
        .results-table .result-correct-cell {
            color: var(--correct-color);
            font-weight: bold;
        }
        .results-table .result-incorrect-cell {
            color: var(--incorrect-color);
            font-weight: bold;
        }

        /* レスポンシブ対応 */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
                padding-top: calc(15px + 40px);
            }
            h1 { font-size: 2rem; }
            .question-text { font-size: 1.4rem; } 
            .word-item { padding: 6px 10px; font-size: 1rem; } 
            .btn, .category-button { padding: 10px 20px; font-size: 1rem; }
            
            /* スマホサイズでは2列表示 */
            #category-list {
                grid-template-columns: repeat(2, 1fr); 
            }
        }
    </style>
</head>
<body>

    <a id="back-to-menu-button" class="top-left-button" href="index.html">ゲーム選択に戻る</a>
    
    <div id="menu-container" class="container">
        <h1>並べ替えドリル</h1>
        
        <div id="mode-selection">
            <button id="mode-practice" class="category-button">練習モード</button>
            <button id="mode-test" class="category-button">テストモード</button>
        </div>
        
        <div id="quiz-count-selection" class="hidden">
            <div id="count-list">
                <button id="count-5" class="category-button">5問</button>
                <button id="count-10" class="category-button">10問</button>
                <button id="count-20" class="category-button">20問</button>
            </div>
        </div>

        <div id="category-selection" class="hidden">
            <p>次に、挑戦したい**カテゴリ**を選んでください。</p>
            <div id="category-list">
                </div>
        </div>
    </div>

    <div id="quiz-container" class="container hidden">
        
        <div id="result-summary-container" class="hidden">
            <h2>結果一覧</h2>
            <p id="test-summary-message" style="font-size: 1.5em; font-weight: bold; margin-bottom: 20px;"></p>
            <table id="results-table" class="results-table">
                </table>
             <button id="back-to-menu-from-result" class="btn back-link" style="margin-top: 20px;">メニューに戻る</button>
        </div>

        <div id="question-area">
            <div id="timer-display" class="timer-style hidden">00:20</div>
            
            <h2 id="quiz-category-title"></h2>
            <p id="japanese-question" class="question-text"></p>
            
            <p style="font-size: 0.9em; color: #7f8c8d; margin: 0;">【解答欄: ドラッグ＆ドロップで並べ替え】</p>
            <div id="answer-area" class="word-box">
                </div>

            <div id="correct-answer-display" class="hidden"></div>
            
            <p style="font-size: 0.9em; color: #7f8c8d; margin: 0;">【選択肢: タップで解答欄へ】</p>
            <div id="options-area" class="word-box">
                </div>

            <div class="button-container">
                <button id="check-button" class="btn">答え合わせ</button>
                <button id="next-button" class="btn hidden">次の問題へ</button>
            </div>
            
            <p id="result-message"></p>
        </div>
    </div>

    <script>
        // ==================================
        // 定数 (テストモードの制限時間)
        // ==================================
        const TIME_LIMIT_PER_QUIZ = 20;
        
        // ==================================
        // DOM要素の取得
        // ==================================
        const menuContainer = document.getElementById('menu-container');
        const quizContainer = document.getElementById('quiz-container');
        
        const backToMenuButton = document.getElementById('back-to-menu-button'); 
        const modePracticeButton = document.getElementById('mode-practice');
        const modeTestButton = document.getElementById('mode-test');
        // 修正: backToModeSelectionButton は削除
        const quizCountSelection = document.getElementById('quiz-count-selection');
        const countList = document.getElementById('count-list');
        const categorySelection = document.getElementById('category-selection');
        const categoryList = document.getElementById('category-list');
        
        const timerDisplay = document.getElementById('timer-display');
        const japaneseQuestion = document.getElementById('japanese-question');
        const quizCategoryTitle = document.getElementById('quiz-category-title');
        const answerArea = document.getElementById('answer-area');
        const optionsArea = document.getElementById('options-area');
        const checkButton = document.getElementById('check-button');
        const nextButton = document.getElementById('next-button');
        const resultMessage = document.getElementById('result-message');
        const questionArea = document.getElementById('question-area');
        
        const resultSummaryContainer = document.getElementById('result-summary-container');
        const resultsTable = document.getElementById('results-table');
        const backToMenuFromResultButton = document.getElementById('back-to-menu-from-result');
        
        // ==================================
        // ゲーム状態変数
        // ==================================
        let availableQuizzes = [];
        let currentQuizIndex = 0;
        let currentQuizData = null;
        let currentMode = '';
        let selectedQuizCount = 0;
        let testResults = [];
        let isAnswered = false;
        
        let timerInterval = null;
        let timeLeft = TIME_LIMIT_PER_QUIZ;
        let sortableAnswer = null;
        
        // ==================================
        // 単語移動ハンドラ
        // ==================================
        const handleItemClick = (e) => {
            if (isAnswered) return;
            
            const item = e.target.closest('.word-item');
            if (!item) return;

            const parent = item.parentNode;

            if (parent === optionsArea) {
                // 選択肢エリアから解答エリアへ (末尾に追加)
                answerArea.appendChild(item);
                item.style.cursor = 'grab'; 
            } else if (parent === answerArea) {
                // 解答エリアから選択肢エリアへ (元の場所に戻す)
                optionsArea.appendChild(item);
                item.style.cursor = 'pointer'; 
            }
        };

        // ==================================
        // 関数定義
        // ==================================
        
        const getCssVar = (propertyName) => {
            return getComputedStyle(document.documentElement).getPropertyValue(propertyName).trim();
        };

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function showScreen(screenId) {
            if (screenId === 'menu') {
                menuContainer.classList.remove('hidden');
                quizContainer.classList.add('hidden');
                // 修正: backToMenuButton は HTML で hidden クラスが削除されたため、
                // JSでの表示/非表示制御は不要だが、念のためメニュー表示時に処理をしない
                resetMenuUI();
            } else if (screenId === 'quiz') {
                menuContainer.classList.add('hidden');
                quizContainer.classList.remove('hidden');
                resultSummaryContainer.classList.add('hidden');
                questionArea.classList.remove('hidden');
                // backToMenuButton は常に表示
            }
        }
        
        function resetMenuUI() {
            modePracticeButton.style.opacity = '1.0';
            modeTestButton.style.opacity = '1.0';
            quizCountSelection.classList.add('hidden');
            categorySelection.classList.add('hidden');
            // 修正: backToModeSelectionButton は削除
        }

        // ★★★ 修正点 1: createCategoryButtons 関数 ★★★
        function createCategoryButtons() {
            // allQuizData (const) を直接変更せず、ローカル変数でデータを結合する
            
            if (typeof allQuizData === 'undefined') {
                console.error("問題データ (allQuizData) が読み込まれていません。");
                categoryList.innerHTML = '<p style="color: red;">エラー: 問題データ(quizData.js)が読み込めません。</p>';
                return;
            }
            
            // allQuizData をコピーして新しい配列を作成
            let combinedQuizData = [...allQuizData];
            
            // grammarQuizData.js が読み込まれていれば、結合する
            if (typeof grammarQuizData !== 'undefined' && grammarQuizData.length > 0) {
                combinedQuizData = combinedQuizData.concat(grammarQuizData);
            } else {
                console.warn('grammarQuizData.js が読み込まれていないか、空です。');
            }
            
            // グローバルな allQuizData の代わりに、結合した combinedQuizData を使用する
            const categories = [...new Set(combinedQuizData.map(quiz => quiz.category))];
            categoryList.innerHTML = '';
            
            categories.forEach(category => {
                const button = document.createElement('button');
                // パターン番号を削除して表示 (文法項目別カテゴリは "パターン X:" がないのでそのまま表示される)
                button.textContent = category.replace(/パターン \d+: /, ''); 
                button.className = 'category-button';
                
                // ★ 修正点: selectCategory に結合したデータ(combinedQuizData)を渡すようにする ★
                button.addEventListener('click', () => selectCategory(category, combinedQuizData));
                categoryList.appendChild(button);
            });
            
            showScreen('menu');
        }

        function selectMode(mode) {
            currentMode = mode;
            
            modePracticeButton.style.opacity = mode === 'practice' ? '1.0' : '0.5';
            modeTestButton.style.opacity = mode === 'test' ? '1.0' : '0.5';
            
            // 修正: モード選択に戻るボタンを削除したため、この処理は不要

            // 練習モードでも問題数選択を表示
            quizCountSelection.classList.remove('hidden');
            categorySelection.classList.add('hidden');
        }

        function resetToModeSelection() {
            // 修正: モード選択に戻るボタンが削除され、常に「ゲーム選択に戻る」があるため、この関数は不要だが、
            // 互換性のため currentMode のリセットと UI リセットのみ行う（今は使われていない）
            currentMode = '';
            selectedQuizCount = 0;
            resetMenuUI();
        }
        
        function selectQuizCount(count) {
            selectedQuizCount = count;
            Array.from(countList.children).forEach(btn => {
                const btnCount = parseInt(btn.id.replace('count-', ''));
                btn.style.opacity = btnCount === count ? '1.0' : '0.5';
            });
            
            categorySelection.classList.remove('hidden');
        }
        
        // ★★★ 修正点 2: selectCategory 関数 ★★★
        // 第2引数 (dataToUse) で、ボタン作成時に使用した結合済みデータを受け取る
        function selectCategory(category, dataToUse) {
            
            // グローバルな allQuizData の代わりに、渡された dataToUse からカテゴリを絞り込む
            availableQuizzes = dataToUse.filter(quiz => quiz.category === category);
            shuffleArray(availableQuizzes);
            
            if (selectedQuizCount > 0) {
                availableQuizzes = availableQuizzes.slice(0, selectedQuizCount);
            }
            
            currentQuizIndex = 0;
            testResults = [];
            isAnswered = false;

            showScreen('quiz');
            loadQuiz();
        }

        function loadQuiz() {
            if (currentQuizIndex >= availableQuizzes.length || availableQuizzes.length === 0) {
                showResult();
                return;
            }

            currentQuizData = availableQuizzes[currentQuizIndex];
            isAnswered = false;
            
            // UIリセット
            resultMessage.textContent = '';
            
            checkButton.classList.remove('hidden');
            nextButton.classList.add('hidden');
            nextButton.textContent = '次の問題へ'; 

            answerArea.style.borderColor = getCssVar('--primary-color'); 
            answerArea.style.borderStyle = 'dashed';

            // タイマーの表示/非表示 (テストモードのみ)
            if (currentMode === 'test') {
                timerDisplay.classList.remove('hidden');
                startTimer();
            } else {
                timerDisplay.classList.add('hidden');
            }
            
            // 問題情報の表示
            const questionNumber = currentQuizIndex + 1;
            const totalQuestions = availableQuizzes.length;
            
            // 何問中何問の数字を赤色にし、パターン名も表示
            const categoryText = currentQuizData.category;
            quizCategoryTitle.innerHTML = `<span class="quiz-status-number">${questionNumber}</span>/<span class="quiz-status-number">${totalQuestions}</span> - ${categoryText}`;
            
            japaneseQuestion.textContent = currentQuizData.ja;

            // 句読点（ピリオド, クエスチマーク, コンマ）をすべて独立した単語として扱う
            const tempSentence = currentQuizData.en.replace(/([.?!,])/g, ' $1 ').trim();
            const rawWords = tempSentence.split(/\s+/).filter(word => word.length > 0);
            
            const shuffledWords = shuffleArray([...rawWords]);
            
            answerArea.innerHTML = '';
            optionsArea.innerHTML = '';

            // 単語タイル生成
            shuffledWords.forEach(word => {
                const item = document.createElement('div');
                item.className = 'word-item';
                item.textContent = word;
                optionsArea.appendChild(item);
            });
            
            // Sortable.jsを初期化
            initializeSortable();
            
            // タップ操作のカーソルをリセット
            Array.from(optionsArea.children).forEach(item => {
                 item.style.cursor = 'pointer';
            });
        }

        function initializeSortable() {
            if (sortableAnswer) sortableAnswer.destroy();
            
            // 解答エリア (Answer Area) - 内部での並べ替えのみ許可
            sortableAnswer = new Sortable(answerArea, {
                animation: 150,
                group: { name: 'answer-group', pull: false, put: false },
            });
        }
        
        function startTimer() {
            stopTimer();
            timeLeft = TIME_LIMIT_PER_QUIZ;
            timerDisplay.textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
            
            const primaryColor = getCssVar('--primary-color');
            const incorrectColor = getCssVar('--incorrect-color');

            timerDisplay.style.borderColor = primaryColor;
            timerDisplay.style.color = primaryColor;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 5 && timeLeft > 0) {
                    timerDisplay.style.borderColor = incorrectColor;
                    timerDisplay.style.color = incorrectColor;
                } else if (timeLeft > 5) {
                    timerDisplay.style.borderColor = primaryColor;
                    timerDisplay.style.color = primaryColor;
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = 'TIME UP';
                    checkAnswer(true);
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function checkAnswer(isTimeout = false) {
            if (isAnswered) return;
            isAnswered = true;
            stopTimer();
            
            const correctColor = getCssVar('--correct-color');
            const incorrectColor = getCssVar('--incorrect-color');

            const userAnswerWords = Array.from(answerArea.children).map(item => item.textContent.trim());
            const userAnswer = userAnswerWords.join(' ').trim();
            const correctAnswer = currentQuizData.en.trim();

            // 比較用に句読点と大文字小文字を無視して正規化
            const normalize = (text) => text.toLowerCase().replace(/[.,;?!]/g, '').trim();
            const isCorrect = normalize(userAnswer) === normalize(correctAnswer);

            // UIの更新
            checkButton.classList.add('hidden');
            nextButton.classList.remove('hidden');
            
            // ドラッグ操作を無効化
            if (sortableAnswer) sortableAnswer.option('disabled', true);

            // フィードバック表示
            if (isTimeout) {
                resultMessage.className = 'incorrect';
                resultMessage.textContent = '❌ 時間切れです！不正解。';
                answerArea.style.borderColor = incorrectColor;
                answerArea.style.borderStyle = 'solid';
            } else {
                if (isCorrect) {
                    resultMessage.className = 'correct';
                    resultMessage.textContent = '⭕ 正解です！';
                    answerArea.style.borderColor = correctColor;
                    answerArea.style.borderStyle = 'solid';
                } else {
                    resultMessage.className = 'incorrect';
                    resultMessage.textContent = '❌ 残念！不正解です。';
                    answerArea.style.borderColor = incorrectColor;
                    answerArea.style.borderStyle = 'solid';
                }
            }
            
            // 結果を保存
            testResults.push({
                question: currentQuizData.ja,
                correctAnswer: correctAnswer,
                userAnswer: userAnswer,
                isCorrect: isCorrect,
                time: isTimeout ? 'TIMEOUT' : (TIME_LIMIT_PER_QUIZ - timeLeft)
            });
            
            if (currentQuizIndex === availableQuizzes.length - 1) {
                nextButton.textContent = '結果を見る';
            } else {
                nextButton.textContent = '次の問題へ';
            }
        }

        function nextQuiz() {
            if (currentQuizIndex === availableQuizzes.length - 1) {
                showResult();
                return;
            }
            
            currentQuizIndex++;
            loadQuiz();
        }

        function showResult() {
            stopTimer();
            // backToMenuButton は常に表示されているため制御は不要

            questionArea.classList.add('hidden');
            resultSummaryContainer.classList.remove('hidden');

            const total = testResults.length;
            const correct = testResults.filter(res => res.isCorrect).length;
            const accuracy = total > 0 ? ((correct / total) * 100).toFixed(1) : 0;
            
            const summaryMessage = `正解数: ${correct} / ${total} 問 (正答率: ${accuracy}%)`;
            document.getElementById('test-summary-message').textContent = summaryMessage;
            
            // タイトルをモードに応じて変更
            document.querySelector('#result-summary-container h2').textContent = 
                currentMode === 'test' ? 'テスト結果' : '練習結果';


            // 結果テーブルの生成
            let tableHTML = `
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>日本語訳</th>
                        <th>正解</th>
                        <th>あなたの解答</th>
                        <th>結果</th>
                        ${currentMode === 'test' ? '<th>所要時間 (秒)</th>' : ''}
                    </tr>
                </thead>
                <tbody>
            `;
            
            testResults.forEach((res, index) => {
                const resultText = res.isCorrect ? '正解' : '不正解';
                const resultClass = res.isCorrect ? 'result-correct-cell' : 'result-incorrect-cell';
                // 練習モードでは時間を表示しない
                const timeCell = currentMode === 'test' 
                    ? `<td>${res.time === 'TIMEOUT' ? 'タイムアウト' : res.time + '秒'}</td>` 
                    : '';
                
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: left;">${res.question}</td>
                        <td class="result-correct-text" style="text-align: left;">${res.correctAnswer}</td>
                        <td style="text-align: left;">${res.userAnswer}</td>
                        <td class="${resultClass}">${resultText}</td>
                        ${timeCell}
                    </tr>
                `;
            });

            tableHTML += '</tbody>';
            resultsTable.innerHTML = tableHTML;
        }

        function backToMenu() {
            stopTimer();
            currentMode = '';
            selectedQuizCount = 0;
            testResults = [];
            // ★ 修正点: データを再結合させるため、createCategoryButtons を再度呼び出す
            createCategoryButtons();
        }


        // ==================================
        // イベントリスナー
        // ==================================
        modePracticeButton.addEventListener('click', () => selectMode('practice'));
        modeTestButton.addEventListener('click', () => selectMode('test'));
        // 修正: backToModeSelectionButton のイベントリスナーを削除
        
        Array.from(countList.children).forEach(btn => {
            btn.addEventListener('click', () => {
                const count = parseInt(btn.id.replace('count-', ''));
                selectQuizCount(count);
            });
        });

        checkButton.addEventListener('click', () => checkAnswer(false));
        nextButton.addEventListener('click', nextQuiz);
        
        backToMenuFromResultButton.addEventListener('click', backToMenu);

        // タップ（クリック）移動のリスナー
        optionsArea.addEventListener('click', handleItemClick);
        answerArea.addEventListener('click', handleItemClick);

        // アプリケーションの初期起動
        window.onload = createCategoryButtons;
    </script>
</body>
</html>